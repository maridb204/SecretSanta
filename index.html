<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå‡∏°‡∏≤‡∏™ üéÑ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç (‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô = ‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Christmas theme colors */
      --bg1:#07120b; --bg2:#11261b; /* deep green background */
      --card: rgba(255,255,255,.04);
      --bd: rgba(255,255,255,.08);
      --txt:#f6f6f6; --mut:rgba(246,246,246,.78);
      --accent-green:#2bb673; --accent-red:#d64545; --accent-gold:#ffd54a;
      --danger:#ff6b6b; --ok:#55e5a1;
    }
    *{box-sizing:border-box}
    body,html{
      margin:0; color:var(--txt);
      font-family: 'Sarabun', system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(1100px 600px at 20% 10%, #1a2d6d 0%, transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, #5b1b5c 0%, transparent 60%),
                  linear-gradient(160deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:18px; display:grid; gap:14px;}
    .top{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
      padding:14px 16px; border-radius:18px; background:var(--card); border:1px solid var(--bd);
      backdrop-filter: blur(10px);
    }
    .title{font-weight:900; font-size:20px; display:flex; gap:10px; align-items:center;}
    .pill{
      padding:8px 12px; border:1px solid var(--bd); border-radius:999px;
      background: rgba(255,255,255,.06); color:var(--mut); font-size:13px;
    }

    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px;}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr;} }

    .card{
      border-radius:18px; background:var(--card); border:1px solid var(--bd);
      backdrop-filter: blur(10px);
      padding:14px;
    }

    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
    label{color:var(--mut)}
    input, button{
      border-radius:14px; border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06); color:var(--txt);
      padding:10px 12px; font-size:16px;
      outline:none;
    }
    input{width:160px}
    button{cursor:pointer; font-weight:900}
    button.primary{
      border-color: rgba(255,213,74,.35);
      background: linear-gradient(180deg, rgba(255,213,74,.22), rgba(255,213,74,.10));
    }
    button.danger{
      border-color: rgba(255,92,122,.40);
      background: linear-gradient(180deg, rgba(255,92,122,.22), rgba(255,92,122,.10));
    }
    button.ghost{
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
    }
    button:disabled{opacity:.5; cursor:not-allowed}

    /* Gift box scene */
    .scene{
      position:relative;
      min-height:520px;
      display:grid;
      place-items:center;
      /* overflow:hidden; */
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.12);
      background:
        radial-gradient(600px 280px at 50% 30%, rgba(255,213,74,.14), transparent 65%),
        radial-gradient(420px 220px at 30% 70%, rgba(85,229,161,.10), transparent 60%),
        radial-gradient(520px 260px at 70% 80%, rgba(255,92,122,.10), transparent 60%),
        rgba(255,255,255,.03);
    }
    .sparkle{
      position:absolute; inset:-40px;
      background: radial-gradient(circle at 10% 20%, rgba(255,255,255,.10), transparent 22%),
                  radial-gradient(circle at 80% 30%, rgba(255,255,255,.08), transparent 18%),
                  radial-gradient(circle at 40% 70%, rgba(255,255,255,.06), transparent 18%),
                  radial-gradient(circle at 65% 55%, rgba(255,255,255,.06), transparent 18%);
      filter: blur(0.5px);
      opacity:.75;
      animation: float 8s ease-in-out infinite;
      pointer-events:none;
    }

@keyframes float{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

    /* String lights across top */
    .lights{ position:fixed; left:0; right:0; top:6px; height:36px; pointer-events:none; z-index:900; display:flex; justify-content:center; align-items:center }
    .light-string{ width:90%; max-width:1100px; display:flex; gap:12px; justify-content:center; align-items:center }
    .bulb{ width:12px; height:18px; border-radius:6px; box-shadow: 0 6px 18px rgba(0,0,0,.35); transform-origin:center; animation: twinkle 2.2s infinite; }
    .bulb.red{ background: linear-gradient(180deg,#ff6b6b,#c83b3b); box-shadow: 0 0 10px rgba(216,78,78,.9); }
    .bulb.green{ background: linear-gradient(180deg,#33b56b,#1f7a4f); box-shadow: 0 0 10px rgba(43,182,115,.9); }
    .bulb.gold{ background: linear-gradient(180deg,#ffd54a,#d4a11a); box-shadow: 0 0 10px rgba(255,213,74,.9); }
    @keyframes twinkle{ 0%{transform:scale(.9); opacity:.7} 50%{transform:scale(1.08); opacity:1} 100%{transform:scale(.9); opacity:.7} }

    .boxWrap{
      position:relative;
      width:min(420px, 86vw);
      aspect-ratio: 1 / 1;
      display:grid;
      place-items:center;
    }


    .giftBox{
      position:relative;
      width: 64%;
      height: 48%;
      transform: translateY(30px);
      filter: drop-shadow(0 22px 26px rgba(0,0,0,.35));
    }
    .base{
      position:absolute; inset:0;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,92,122,.92), rgba(255,92,122,.62));
      border: 1px solid rgba(255,255,255,.18);
      overflow:hidden;
    }
    .ribbonV{
      position:absolute; left:50%; top:-2%;
      width: 14%;
      height: 104%;
      transform: translateX(-50%);
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(43,182,115,.96), rgba(30,120,75,.70));
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.10);
    }
    .ribbonH{
      position:absolute; left:-2%; top:50%;
      width: 104%;
      height: 16%;
      transform: translateY(-50%);
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(214,69,69,.96), rgba(170,45,45,.72));
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.10);
    }
    .lid{
      position: absolute;
      width: 110%;
      height: 40%;
      left: -5%;
      top: -30%;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(210,60,60,0.9), rgba(180,40,40,1));
      border-radius: 1px solid rgba(255,255,255,.18);
      transform-origin: 15% 90%;
      transform: rotate(0deg) translateY(0);
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.25));
      z-index: 1;
    }
    .lid:before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(255,255,255,.00), rgba(255,255,255,.18), rgba(255,255,255,.00));
      opacity:.24;
      border-radius:18px;
    }
    .bow{
      position:absolute;
      left: 18%;
      top: -18%;
      width: 26%;
      height: 26%;
      transform: rotate(-10deg);
      filter: drop-shadow(0 10px 10px rgba(0,0,0,.18));
    }
    .bow:before, .bow:after{
      content:"";
      position:absolute;
      width: 55%;
      height: 45%;
      top: 20%;
      border-radius: 999px 999px 999px 0;
      background: linear-gradient(180deg, rgba(255,80,80,.98), rgba(210,40,40,.62));
      border:1px solid rgba(0,0,0,.08);
    }
    .bow:before{ left: 0; transform: rotate(-18deg); }
    .bow:after{ right: 0; transform: rotate(18deg) scaleX(-1); }
    .knot{
      position:absolute; left:50%; top:42%;
      width: 26%;
      height: 26%;
      transform: translate(-50%,-50%);
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255,213,74,.98), rgba(255,213,74,.70));
      border:1px solid rgba(0,0,0,.10);
    }

    .numberInside{
      position:absolute;
      left:50%;
      top: 38%;
      transform: translate(-50%, 60px) scale(.85);
      width: 82%;
      padding: 12px 10px;
      border-radius: 16px;
      background: rgba(10,15,35,.45);
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      text-align:center;
      opacity:0;
      pointer-events:none;
      z-index: 2;
    }
    .numberInside .cap{ color:var(--mut); font-size:13px; }
    .numberInside .num{
      font-size:56px; font-weight:950; letter-spacing:1px;
      text-shadow: 0 10px 28px rgba(0,0,0,.55);
      margin-top: 2px;
    }
    .numberInside .cap2{ color:var(--mut); font-size:12px; margin-top:4px; }

    #confetti{ position:absolute; inset:0; pointer-events:none; z-index:10000; }

    .shaking .giftBox{ animation: shake .6s ease-in-out infinite; }
    @keyframes shake{
      0%,100%{ transform: translateY(30px) rotate(0deg); }
      25%{ transform: translateY(30px) rotate(-1.6deg); }
      50%{ transform: translateY(30px) rotate(1.6deg); }
      75%{ transform: translateY(30px) rotate(-1.2deg); }
    }

    /* Leftward suspense shake (one-shot) */
    .shakeLeft .giftBox{ animation: shakeLeft 800ms ease-in-out both; }
    @keyframes shakeLeft{
      0%{ transform: translateY(30px) translateX(0) rotate(0deg); }
      15%{ transform: translateY(30px) translateX(-32px) rotate(-12deg); }
      35%{ transform: translateY(30px) translateX(28px) rotate(12deg); }
      55%{ transform: translateY(30px) translateX(-24px) rotate(-10deg); }
      75%{ transform: translateY(30px) translateX(12px) rotate(8deg); }
      100%{ transform: translateY(30px) translateX(0) rotate(0deg); }
    }

    .opening .lid{ animation: openLid 900ms cubic-bezier(.18,.88,.22,1) forwards; }
    @keyframes openLid{
      0%{ transform: rotate(0deg) translateY(0); }
      70%{ transform: rotate(-48deg) translateY(-8px); }
      100%{ transform: rotate(-62deg) translateY(-10px); }
    }

    .closing .lid{ animation: closeLid 900ms cubic-bezier(.22,.88,.18,1) forwards; }
    @keyframes closeLid{
      0%{ transform: rotate(-62deg) translateY(-10px); }
      30%{ transform: rotate(-48deg) translateY(-8px); }
      100%{ transform: rotate(0deg) translateY(0); }
    }

    /* Santa in main scene */
    .sceneSanta{
      position: absolute;
      width: 100px;
      height: 100px;
      left: 5%;
      top: 15%;
      opacity: 0;
      transform: scale(0) rotate(-20deg);
      pointer-events: none;
      z-index: 15;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,0.3));
    }
    .sceneSanta img{
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .opening .sceneSanta{
      animation: sceneSantaPop 1s cubic-bezier(0.34, 1.56, 0.64, 1) 0.4s forwards;
    }
    .closing .sceneSanta{
      animation: sceneSantaHide 0.5s ease-in forwards;
    }
    @keyframes sceneSantaPop{
      0%{ opacity:0; transform: scale(0) rotate(-20deg) translateY(40px); }
      60%{ opacity:1; transform: scale(1.2) rotate(-8deg) translateY(-10px); }
      80%{ transform: scale(0.9) rotate(4deg) translateY(3px); }
      100%{ opacity:1; transform: scale(1) rotate(0deg) translateY(0); }
    }
    @keyframes sceneSantaHide{
      0%{ opacity:1; transform: scale(1) rotate(0deg); }
      100%{ opacity:0; transform: scale(0) rotate(-20deg) translateY(40px); }
    }

    /* glowBeam removed */
    .showResult .numberInside{
      opacity:1;
      transform: translate(-50%, -10px) scale(1);
      transition: 520ms cubic-bezier(.18,.95,.18,1);
    }

    .hint{font-size:14px; color:var(--mut); line-height:1.5}
    .stat{display:grid; gap:10px; margin-top:10px;}
    .kpi{display:flex; align-items:baseline; justify-content:space-between; gap:10px;}
    .kpi .n{font-size:22px; font-weight:900}
    .kpi .t{color:var(--mut)}
    .nums{display:flex; flex-wrap:wrap; gap:6px}

    /* pills */
    .numPill{
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      font-size:13px;
      user-select:none;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
    }
    .numPill.clickable{ cursor:pointer; }
    .numPill.clickable:hover{ transform: translateY(-1px) scale(1.03); border-color: rgba(255,255,255,.26); }
    .numPill.active{
      border-color: rgba(255,213,74,.55);
      background: rgba(255,213,74,.14);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .numPill.gone{opacity:.45; text-decoration:line-through; cursor:not-allowed}

    /* Gift selection grid */
    .giftSelector{ margin-top:10px; display:grid; grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); gap:8px; }
    .giftBox-btn{ min-height:50px; padding:0; font-size:20px; }
    .giftBox-btn:disabled{ opacity:.35; cursor:not-allowed; }
    .giftBox-btn{ min-height:50px; padding:0; font-size:20px; }
    .giftBox-btn:disabled{ opacity:.35; cursor:not-allowed; }
    .giftBox-btn{ 
      aspect-ratio: 1 / 1; 
      border-radius:12px; border:2px solid rgba(255,255,255,.18);
      background: linear-gradient(135deg, rgba(210,60,60,.35), rgba(43,182,115,.35));
      cursor:pointer; user-select:none; font-weight:900;
      transition: all 140ms ease; padding:0;
      display:grid; place-items:center; font-size:24px;
    }
    .giftBox-btn:hover:not(:disabled){ transform: scale(1.08); border-color: rgba(255,255,255,.35); background: linear-gradient(135deg, rgba(210,60,60,.45), rgba(43,182,115,.45)); }
    .giftBox-btn:active:not(:disabled){ transform: scale(.95); }
    .giftBox-btn:disabled{ opacity:.3; cursor:not-allowed; }

    .msg{margin-top:8px; color:var(--gold); min-height: 22px;}
    .ok{color:var(--ok)}

    /* --- Modal base --- */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      place-items:center;
      padding: 18px;
      z-index: 9999;
    }
    .modalOverlay.show{ display:grid; }
    .modal{
      width: min(600px, 96vw);
      border-radius: 18px;
      background: rgba(12, 16, 40, .78);
      border: 1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(14px);
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      padding: 14px;
      transform: translateY(8px) scale(.98);
      animation: pop 180ms ease-out forwards;
    }
    @keyframes pop{ to { transform: translateY(0) scale(1); } }
    .modalHeader{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding: 8px 8px 12px;
    }
    .modalTitle{ font-weight:950; font-size:18px; }
    .xBtn{
      width:40px; height:40px; border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      cursor:pointer; color:var(--txt); font-weight:900;
    }
    .modalBody{ padding: 0 8px 10px; color: var(--mut); line-height: 1.55; }
    .modalFooter{
      display:flex; gap:10px; justify-content:flex-end; padding: 10px 8px 8px;
      flex-wrap:wrap;
    }

    /* Emphasize the setup start button */
    #setupStartBtn{
      font-size:18px; padding:12px 18px; border-radius:12px; cursor:pointer;
      background: linear-gradient(180deg, rgba(255,213,74,0.98), rgba(255,193,7,0.95));
      color: #111; border: 1px solid rgba(0,0,0,0.12);
      box-shadow: 0 14px 40px rgba(255,193,7,0.12), inset 0 -2px 0 rgba(0,0,0,0.06);
      font-weight:900; letter-spacing:0.6px;
      font-family: Sarabun;
    }
    #setupStartBtn:not(:disabled):hover{ transform: translateY(-2px); box-shadow: 0 20px 60px rgba(255,193,7,0.16); }
    #setupStartBtn:disabled{ opacity:0.48; filter:grayscale(.1); cursor:not-allowed; }
    .warnBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,92,122,.35);
      background: rgba(255,92,122,.10);
      color: rgba(255,220,230,.95);
      font-size: 14px;
    }
    .tiny{ font-size: 12px; opacity: .85; }

    /* player setup pills */
    .setupGrid{ margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; }
    .pickPill{
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      font-weight:800;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      min-width: 48px;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .pickPill:hover{ transform: translateY(-1px) scale(1.02); border-color: rgba(255,255,255,.28); }
    .pickPill.on{
      border-color: rgba(85,229,161,.45);
      background: rgba(85,229,161,.14);
      box-shadow: 0 14px 30px rgba(0,0,0,.30);
    }
    /* Fullscreen fake-draw overlay (more colorful, iPad-friendly) */
    #randomOverlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(6,12,20,0.96), rgba(4,48,28,0.92));
      z-index:9999; color:var(--txt);
      font-family: inherit; padding:24px;
    }
    #randomOverlay.show{ display:flex; }
    #randomOverlay .randomBox{
      text-align:center; padding:36px 28px; border-radius:20px; backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 40px 120px rgba(0,0,0,0.6), 0 8px 30px rgba(0,0,0,0.4);
      width: min(820px, 92vw);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      position:relative; z-index:1;
    }
    #randomOverlay .num{
      font-size: 180px; font-weight: 900; line-height:1; letter-spacing:6px;
      /* Use a solid, high-contrast fill with stroke and deep shadow for clarity */
      color: var(--accent-gold);
      -webkit-text-stroke: 2px rgba(0,0,0,0.72);
      text-shadow:
        0 2px 0 rgba(0,0,0,0.9),
        0 10px 28px rgba(0,0,0,0.65),
        0 4px 10px rgba(255,240,200,0.06);
      filter: drop-shadow(0 10px 24px rgba(0,0,0,0.55));
      position:relative; z-index:4;
    }
    #randomOverlay .sub{ margin-top:18px; color:var(--mut); font-size:20px; font-weight:700 }

    /* Santa animation */
    #randomOverlay .santa{
      position:absolute; 
      width: 100px;
      height: 100px;
      opacity: 0;
      transform: scale(0) rotate(-15deg);
      animation: santaPop 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      z-index:5;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,0.25));
    }
    #randomOverlay .santa img{
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    #randomOverlay .santa.left{ left: 8%; top: 15%; animation-delay: 0.3s; }
    #randomOverlay .santa.right{ right: 8%; top: 20%; animation-delay: 0.5s; transform: scale(0) rotate(15deg); }
    @keyframes santaPop{
      0%{ opacity:0; transform: scale(0) rotate(-15deg) translateY(30px); }
      60%{ opacity:1; transform: scale(1.15) rotate(-5deg) translateY(-8px); }
      80%{ transform: scale(0.95) rotate(3deg) translateY(2px); }
      100%{ opacity:1; transform: scale(1) rotate(0deg) translateY(0); }
    }

    /* iPad / tablet sizing */
    @media (min-width:768px) and (max-width:1024px){
      #randomOverlay .num{ font-size: 220px; -webkit-text-stroke:3px rgba(0,0,0,0.72); }
      #randomOverlay .sub{ font-size:24px; }
      #randomOverlay .randomBox{ padding:48px 36px; }
    }
    /* overlay-local confetti canvas (renders above the box background but below the number) */
    #randomOverlay canvas#confettiOverlay{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; z-index:2; }
    /* small screens */
    @media (max-width:480px){
      #randomOverlay .num{ font-size: 84px; letter-spacing:2px; }
      #randomOverlay .randomBox{ padding:18px; width:90vw; }
      #randomOverlay .sub{ font-size:14px; }
      #randomOverlay .santa{ width: 60px; height: 60px; }
      #randomOverlay .santa.left{ left: 5%; top: 10%; }
      #randomOverlay .santa.right{ right: 5%; top: 12%; }
      .sceneSanta{ width: 70px; height: 70px; }
    }
  </style>
</head>

<body>
  <div class="lights" aria-hidden="true">
    <div class="light-string">
      <!-- bulbs will be styled purely via CSS classes -->
      <div class="bulb red"></div>
      <div class="bulb green"></div>
      <div class="bulb gold"></div>
      <div class="bulb red"></div>
      <div class="bulb green"></div>
      <div class="bulb gold"></div>
      <div class="bulb red"></div>
      <div class="bulb green"></div>
      <div class="bulb gold"></div>
    </div>
  </div>
  <div class="wrap">
    <div class="top">
      <div class="title">üéÅ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç</div>
      <div class="pill">‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: ‚Äú‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô‚Äù = ‚Äú‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‚Äù (‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô) ‚Ä¢ ‡∏´‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏Ç‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="scene" id="scene">
          <div class="sparkle"></div>
          <canvas id="confetti"></canvas>
          <div class="sceneSanta"><img src="https://api.iconify.design/noto:santa-claus.svg" alt="Santa"></div>

          <div class="boxWrap">
            <!-- glowBeam removed -->

            <div class="giftBox" id="giftBox">
              <div class="numberInside" id="numberInside">
                <div class="cap">üéâ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç</div>
                <div class="num" id="resultText">‚Äî</div>
                <div class="cap2" id="capLine2">‚Äî</div>
              </div>

              <div class="lid">
                <div class="bow"><div class="knot"></div></div>
              </div>

              <div class="base">
                <div class="ribbonV"></div>
                <div class="ribbonH"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="hint" style="margin-top:10px">
          ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏° ‚Üí ‡∏Å‡∏î ‚Äú‡∏•‡∏ö‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡∏•‡∏ö ‚Äú‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‚Äù + ‡∏•‡πá‡∏≠‡∏Å ‚Äú‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‚Äù)
        </div>
      </div>

      <div class="card">
        <div class="row">
          <label>‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô:</label>
          <input id="playerId" type="number" min="1" max="30" inputmode="numeric" placeholder="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á" />
          <button id="randomPlayerBtn" class="ghost" title="‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å">üé≤ ‡∏™‡∏∏‡πà‡∏°</button>
        </div>

        <div style="margin-top:10px;">
          <div class="t" style="margin-bottom:8px; color:var(--mut)">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</div>
          <div class="giftSelector" id="giftSelector"></div>
          <div id="historyDisplay" style="margin-top:12px; font-size:13px; color:var(--mut);"></div>
        </div>

        <div class="row" style="margin-top:10px; display:none;">
          <button id="openBtn" class="primary">ÔøΩÔøΩ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°</button>
          <button id="removeBtn" class="danger" disabled>‚ùå ‡∏•‡∏ö‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å</button>
        </div>

        <div class="msg" id="msg"></div>

        <div class="stat">
          <div class="kpi">
            <div class="t">‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
            <div class="n" id="remainCount">0</div>
          </div>

          <div class="kpi">
            <div class="t">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô</div>
            <div class="n" id="joinCount">0</div>
          </div>

          <div>
            <div class="t" style="margin-bottom:6px">‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ / ‡∏Ç‡∏µ‡∏î‡∏ó‡∏±‡∏ö = ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß)</div>
            <div class="nums" id="playerPills"></div>
          </div>

          <div>
            <div class="t" style="margin-bottom:6px">‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô)</div>
            <div class="nums" id="giftPills"></div>
          </div>

          <div class="kpi" style="margin-top:4px">
            <div class="t">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>
            <div class="n" id="usedCount">0</div>
          </div>
        </div>

        <div class="row" style="margin-top:16px; padding-top:16px; border-top:1px solid var(--bd);">
          <button id="setupBtn" class="ghost">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
          <button id="resetBtn" class="danger">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </div>
    </div>
  </div>

  <div style="text-align:center; padding:20px; opacity:0.5; font-size:12px; color:var(--mut);">
    üéÑ Build: <span id="buildTime"></span>
  </div>

  <!-- Player Setup Modal -->
  <div class="modalOverlay" id="setupOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="setupTitle">
      <div class="modalHeader">
        <div class="modalTitle" id="setupTitle">üë• ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô</div>
        <button class="xBtn" id="setupCloseBtn" title="‡∏õ‡∏¥‡∏î">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="tiny">
          ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏à‡∏∞ ‚Äú‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô‚Äù ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á <b>‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î = ‡∏ä‡∏∏‡∏î‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</b> (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô 100%)<br>
          ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ <b>2</b> ‡∏Ñ‡∏ô
        </div>

        <div class="setupGrid" id="setupGrid"></div>

        <div class="warnBox" id="setupWarn">
          ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ <b>2</b> ‡∏Ñ‡∏ô
        </div>
      </div>
      <div class="modalFooter">
        <button class="ghost" id="setupSelectAll">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button class="ghost" id="setupClearAll">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button class="primary" id="setupStartBtn" disabled>‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- Reset Confirm Modal -->
  <div class="modalOverlay" id="resetOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="resetTitle">
      <div class="modalHeader">
        <div class="modalTitle" id="resetTitle">‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö</div>
        <button class="xBtn" id="resetCloseBtn" title="‡∏õ‡∏¥‡∏î">‚úï</button>
      </div>
      <div class="modalBody">
        ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏à‡∏∞:
        <ul>
          <li>‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏° / ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß / ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß</li>
          <li><b>‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô</b> (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà)</li>
        </ul>

        <div class="warnBox">
          ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ <b>RESET</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Å‡∏î ‚Äú‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‚Äù
        </div>

        <div style="margin-top:12px; display:grid; gap:8px;">
          <label for="resetText" class="tiny">‡∏û‡∏¥‡∏°‡∏û‡πå RESET ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</label>
          <input id="resetText" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå RESET" autocomplete="off" />
          <div class="tiny">‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà/‡πÄ‡∏•‡πá‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="ghost" id="resetCancelBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="danger" id="resetConfirmBtn" disabled>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const N = 50;

  // ‚úÖ ‡∏ï‡∏≠‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô
  let joinedPlayers = [];    // ‡∏ä‡∏∏‡∏î‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô
  let availableGifts = [];   // ‚úÖ ‡∏ä‡∏∏‡∏î‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç = joinedPlayers ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ
  let removedGifts = [];     // ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
  let usedPlayers  = [];     // ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß
  let allGiftNumbers = [];   // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏°‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°)
  let boxToGift = {};        // mapping: ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÑ‡∏´‡∏ô (‡πÄ‡∏•‡∏Ç) -> ‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏≠‡∏∞‡πÑ‡∏£
  let giftAssignment = {};   // mapping: ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô -> ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç (pre-assigned derangement)

  let lastGift = null;
  let lastPlayer = null;
  let busy = false;

  // DOM
  const scene = document.getElementById("scene");
  const playerInput = document.getElementById("playerId");
  const randomPlayerBtn = document.getElementById("randomPlayerBtn");
  const openBtn = document.getElementById("openBtn");
  const removeBtn = document.getElementById("removeBtn");
  const resetBtn = document.getElementById("resetBtn");
  const setupBtn = document.getElementById("setupBtn");
  const msgEl = document.getElementById("msg");

  const remainEl = document.getElementById("remainCount");
  const usedCountEl = document.getElementById("usedCount");
  const joinCountEl = document.getElementById("joinCount");

  const playerPillsEl = document.getElementById("playerPills");
  const giftPillsEl = document.getElementById("giftPills");

  const giftSelector = document.getElementById("giftSelector");

  const resultText = document.getElementById("resultText");
  const capLine2 = document.getElementById("capLine2");
  const historyDisplay = document.getElementById("historyDisplay");

  // Setup modal
  const setupOverlay = document.getElementById("setupOverlay");
  const setupCloseBtn = document.getElementById("setupCloseBtn");
  const setupGrid = document.getElementById("setupGrid");
  const setupStartBtn = document.getElementById("setupStartBtn");
  const setupSelectAll = document.getElementById("setupSelectAll");
  const setupClearAll = document.getElementById("setupClearAll");
  const setupWarn = document.getElementById("setupWarn");
  let setupSelection = new Set();

  // Reset modal
  const resetOverlay = document.getElementById("resetOverlay");
  const resetCloseBtn = document.getElementById("resetCloseBtn");
  const resetCancelBtn = document.getElementById("resetCancelBtn");
  const resetConfirmBtn = document.getElementById("resetConfirmBtn");
  const resetText = document.getElementById("resetText");

  // Confetti
  const conf = document.getElementById("confetti");
  const cctx = conf.getContext("2d");
  let confettiPieces = [];
  let confettiRAF = null;
  // Overlay-specific confetti (for full-screen overlay reveals)
  let confO = null;
  let cctxO = null;
  let confettiPiecesO = [];
  let confettiRAFO = null;

  function resizeConfetti(){
    const r = scene.getBoundingClientRect();
    conf.width = Math.floor(r.width * devicePixelRatio);
    conf.height = Math.floor(r.height * devicePixelRatio);
  }
  function resizeConfettiOverlay(){
    const overlay = document.getElementById('randomOverlay');
    console.log('[resizeConfettiOverlay] called');
    if (!overlay) { console.log('[resizeConfettiOverlay] no overlay'); return; }
    if (!confO) confO = overlay.querySelector('#confettiOverlay');
    if (!confO) { console.log('[resizeConfettiOverlay] no confetti canvas found'); return; }
    const r = overlay.getBoundingClientRect();
    confO.width = Math.floor(r.width * devicePixelRatio);
    confO.height = Math.floor(r.height * devicePixelRatio);
  }
  window.addEventListener("resize", resizeConfetti);
  window.addEventListener("resize", resizeConfettiOverlay);
  resizeConfetti();

  function setBusy(v){
    console.log('[setBusy] ->', v);
    busy = v;
    if (v) openBtn.disabled = true;
    playerInput.disabled = v;
    resetBtn.disabled = v;
    setupBtn.disabled = v;
  }

  function setMsg(text, ok=false){
    msgEl.textContent = text || "";
    msgEl.className = "msg" + (ok ? " ok" : "");
  }

  function isPlayerJoined(id){ return joinedPlayers.includes(id); }
  function isPlayerUsed(id){ return usedPlayers.includes(id); }

  function clampPlayerId(){
    const raw = playerInput.value;
    if (raw === "") return NaN;

    let v = Number(raw);
    if(!Number.isFinite(v)) return NaN;
    v = Math.max(1, Math.min(N, Math.floor(v)));

    // ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô
    if (!isPlayerJoined(v)) { playerInput.value = ""; return NaN; }
    // ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡πà‡∏ô
    if (isPlayerUsed(v)) { playerInput.value = ""; return NaN; }

    playerInput.value = String(v);
    return v;
  }

  function shuffle(arr){
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  // Derangement: ‡∏™‡∏£‡πâ‡∏≤‡∏á permutation ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡πÑ‡∏´‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°
  function createDerangement(arr) {
    const sorted = arr.slice().sort((a, b) => a - b);
    let attempt = 0;
    const maxAttempts = 100;

    while (attempt < maxAttempts) {
      const shuffled = shuffle(sorted.slice());
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡πÑ‡∏´‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°
      let isValid = true;
      for (let i = 0; i < sorted.length; i++) {
        if (sorted[i] === shuffled[i]) {
          isValid = false;
          break;
        }
      }
      if (isValid) {
        console.log('[createDerangement] ‡∏™‡∏£‡πâ‡∏≤‡∏á derangement ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°', attempt + 1, '‡∏Ñ‡∏£‡∏±‡πâ‡∏á:', shuffled);
        return shuffled;
      }
      attempt++;
    }

    // Fallback: ‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡πÑ‡∏õ 1 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
    console.warn('[createDerangement] ‡πÉ‡∏ä‡πâ fallback: ‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡πÑ‡∏õ 1 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
    const fallback = sorted.slice();
    fallback.push(fallback.shift());
    return fallback;
  }

  function randomizeFirstPlayer(){
    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å player ‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡πà‡∏ô
    const availablePlayers = joinedPlayers.filter(p => !usedPlayers.includes(p));
    if (availablePlayers.length === 0) {
      setMsg("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡πà‡∏ô!");
      return;
    }
    const randomIndex = Math.floor(Math.random() * availablePlayers.length);
    playerInput.value = String(availablePlayers[randomIndex]);
    setResult(null, null);
    resetBoxVisual();
    updatePlayerValidityUI();
    // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    try{ if (randomPlayerBtn) randomPlayerBtn.disabled = true; } catch(e){}
  }

  // Fake draw: full-screen animated reveal then set player after pause
  async function startFakeDraw(){
    if (busy) return;
    const availablePlayers = joinedPlayers.filter(p => !usedPlayers.includes(p));
    if (availablePlayers.length === 0){ setMsg("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡πà‡∏ô!"); return; }

    console.log('[startFakeDraw] availablePlayers:', availablePlayers.length, availablePlayers);
    // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏∏‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    try{ if (randomPlayerBtn) randomPlayerBtn.disabled = true; } catch(e){}

    // prepare overlay
    let overlay = document.getElementById('randomOverlay');
    if (!overlay){
      overlay = document.createElement('div'); overlay.id = 'randomOverlay';
      overlay.innerHTML = `<canvas id="confettiOverlay"></canvas><div class="santa left"><img src="https://api.iconify.design/noto:santa-claus.svg" alt="Santa"></div><div class="santa right"><img src="https://api.iconify.design/noto:santa-claus.svg" alt="Santa"></div><div class="randomBox"><div class="num" id="randomNum">‚Äì</div><div class="sub">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å...</div></div>`;
      document.body.appendChild(overlay);
      console.log('[startFakeDraw] created overlay');
      // init overlay confetti canvas context
      confO = overlay.querySelector('#confettiOverlay');
      if (confO) cctxO = confO.getContext('2d');
      // size overlay confetti
      resizeConfettiOverlay();
    }

    const numEl = overlay.querySelector('#randomNum');
    overlay.classList.add('show');
    // size overlay canvas now that it's visible
    resizeConfettiOverlay();
    if (confO) cctxO = confO.getContext('2d');
    console.log('[startFakeDraw] about to set busy=true and start spin');
    setBusy(true);

    // cycling effect: rapid random numbers, then slow down
    let elapsed = 0;
    const spinDuration = 2000; // ms of spinning before settle
    let interval = 50;
    let iv;
    iv = setInterval(() => {
      const pick = availablePlayers[Math.floor(Math.random()*availablePlayers.length)];
      numEl.textContent = String(pick);
    }, interval);

    // slow-down: increase interval progressively until spinDuration
    const start = Date.now();
    while (Date.now() - start < spinDuration){
      await wait(120);
    }
    clearInterval(iv);

    // final pick
    const final = availablePlayers[Math.floor(Math.random()*availablePlayers.length)];
    numEl.textContent = String(final);
    // trigger overlay confetti so it appears with the full-screen reveal
    fireConfettiOverlay();
    console.log('[startFakeDraw] final pick ->', final);
    // keep full-screen reveal for 5s as requested
    await wait(3500);

    overlay.classList.remove('show');
    console.log('[startFakeDraw] overlay closed');
    // set chosen player in input
    playerInput.value = String(final);
    setResult(null, null);
    resetBoxVisual();
    updatePlayerValidityUI();
    renderGiftSelector();
    setBusy(false);
    console.log('[startFakeDraw] done, busy=false');
    // keep random button disabled (only once)
  }

  function highlightActivePlayerPill(playerId){
    const pills = playerPillsEl.querySelectorAll(".numPill");
    pills.forEach(p => p.classList.remove("active"));
    if (!Number.isFinite(playerId)) return;
    const target = Array.from(pills).find(p => Number(p.dataset.num) === playerId);
    if (target) target.classList.add("active");
  }

  function updatePlayerValidityUI(){
    if (busy) return false;

    if (joinedPlayers.length < 2){
      setMsg("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î ‚Äú‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏Ñ‡∏ô", false);
      openBtn.disabled = true;
      removeBtn.disabled = true;
      highlightActivePlayerPill(null);
      return false;
    }

    const v = clampPlayerId();
    if (!Number.isFinite(v)) {
      setMsg("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Äú‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô‚Äù ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡πà‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)", false);
      openBtn.disabled = true;
      removeBtn.disabled = true;
      highlightActivePlayerPill(null);
      return false;
    }

    openBtn.disabled = false;
    highlightActivePlayerPill(v);
    return true;
  }

  function validGiftPool(playerId){
    // ‚úÖ ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î = ‡∏ä‡∏∏‡∏î‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô (availableGifts)
    // ‚úÖ ‡∏´‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
    return availableGifts.filter(g => g !== playerId);
  }

  function setResult(giftNo, playerNo){
    console.log('[setResult] giftNo=', giftNo, 'playerNo=', playerNo);
    lastGift = giftNo;
    lastPlayer = playerNo;

    resultText.textContent = (giftNo == null) ? "‚Äî" : String(giftNo);

    if (giftNo == null || playerNo == null){
      removeBtn.disabled = true;
      scene.classList.remove("showResult");
      capLine2.textContent = "‚Äî";
    } else {
      removeBtn.disabled = false;
      scene.classList.add("showResult");
      capLine2.textContent = `‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${playerNo}`;
    }
  }

  // Confetti
  function spawnConfetti(){
    const w = conf.width, h = conf.height;
    const count = 120;
    const palette = [0, 30, 140]; // red, gold, green
    confettiPieces = Array.from({length:count}, () => {
      const x = Math.random() * w;
      const y = -Math.random() * h * 0.2;
      const size = (6 + Math.random()*10) * devicePixelRatio;
      const speed = (2.2 + Math.random()*4.0) * devicePixelRatio;
      const drift = (-1 + Math.random()*2) * devicePixelRatio;
      const rot = Math.random() * Math.PI*2;
      const rotSp = (-0.15 + Math.random()*0.3);
      const hue = palette[Math.floor(Math.random()*palette.length)] + Math.floor(Math.random()*8 - 4);
      return {x,y,size,speed,drift,rot,rotSp,hue};
    });
  }
  function drawConfetti(){
    const w = conf.width, h = conf.height;
    cctx.clearRect(0,0,w,h);

    let alive = false;
    for(const p of confettiPieces){
      p.y += p.speed;
      p.x += p.drift;
      p.rot += p.rotSp;
      if(p.y < h + 80) alive = true;

      cctx.save();
      cctx.translate(p.x, p.y);
      cctx.rotate(p.rot);
      cctx.fillStyle = `hsl(${p.hue} 90% 60% / 0.95)`;
      cctx.fillRect(-p.size/2, -p.size/3, p.size, p.size*0.66);
      cctx.restore();
    }

    if(alive){
      confettiRAF = requestAnimationFrame(drawConfetti);
    }else{
      cctx.clearRect(0,0,w,h);
      confettiPieces = [];
      confettiRAF = null;
    }
  }
  function fireConfetti(){
    if(confettiRAF) cancelAnimationFrame(confettiRAF);
    spawnConfetti();
    confettiRAF = requestAnimationFrame(drawConfetti);
  }

  // Overlay confetti: similar but rendered into overlay canvas (confO)
  function spawnConfettiOverlay(){
    if (!confO) return;
    const w = confO.width, h = confO.height;
    const count = 96;
    const palette = [0, 30, 140];
    confettiPiecesO = Array.from({length:count}, () => {
      const x = Math.random() * w;
      const y = -Math.random() * h * 0.2;
      const size = (6 + Math.random()*10) * devicePixelRatio;
      const speed = (2.2 + Math.random()*4.0) * devicePixelRatio;
      const drift = (-1 + Math.random()*2) * devicePixelRatio;
      const rot = Math.random() * Math.PI*2;
      const rotSp = (-0.15 + Math.random()*0.3);
      const hue = palette[Math.floor(Math.random()*palette.length)] + Math.floor(Math.random()*8 - 4);
      return {x,y,size,speed,drift,rot,rotSp,hue};
    });
  }
  function drawConfettiOverlay(){
    if (!confO || !cctxO) return;
    const w = confO.width, h = confO.height;
    cctxO.clearRect(0,0,w,h);

    let alive = false;
    for(const p of confettiPiecesO){
      p.y += p.speed;
      p.x += p.drift;
      p.rot += p.rotSp;
      if(p.y < h + 80) alive = true;

      cctxO.save();
      cctxO.translate(p.x, p.y);
      cctxO.rotate(p.rot);
      cctxO.fillStyle = `hsl(${p.hue} 92% 58% / 0.95)`;
      cctxO.fillRect(-p.size/2, -p.size/3, p.size, p.size*0.66);
      cctxO.restore();
    }

    if(alive){
      confettiRAFO = requestAnimationFrame(drawConfettiOverlay);
    }else{
      cctxO.clearRect(0,0,w,h);
      confettiPiecesO = [];
      confettiRAFO = null;
    }
  }
  function fireConfettiOverlay(){
    console.log('[fireConfettiOverlay]');
    const overlay = document.getElementById('randomOverlay');
    if (!overlay) return;
    if (!confO) confO = overlay.querySelector('#confettiOverlay');
    if (!confO) return;
    if (!cctxO) cctxO = confO.getContext('2d');
    if(confettiRAFO) cancelAnimationFrame(confettiRAFO);
    spawnConfettiOverlay();
    confettiRAFO = requestAnimationFrame(drawConfettiOverlay);
  }
  function clearConfettiOverlay(){
    console.log('[clearConfettiOverlay]');
    if (confettiRAFO) cancelAnimationFrame(confettiRAFO);
    if (cctxO && confO) cctxO.clearRect(0,0,confO.width, confO.height);
    confettiPiecesO = [];
    confettiRAFO = null;
  }

  function resetBoxVisual(){
    scene.classList.remove("shaking","opening","showResult");
    void scene.offsetHeight;
  }
  function wait(ms){ return new Promise(r=>setTimeout(r, ms)); }

  async function openSequence(giftNo, playerNo){
    console.log('[openSequence] start gift=', giftNo, 'player=', playerNo);
    resetBoxVisual();
    setResult(null, null);

    scene.classList.add("shaking");
    await wait(650);

    scene.classList.remove("shaking");
    scene.classList.add("opening");
    await wait(900);

    setResult(giftNo, playerNo);
    console.log('[openSequence] showing result');
    fireConfetti();
    setMsg(`‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${giftNo} (‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${playerNo}) üéâ`, true);
  }

  async function doOpen(){
    console.log('[doOpen] entry');
    if (busy) { console.log('[doOpen] busy, abort'); return; }
    if (!updatePlayerValidityUI()) { console.log('[doOpen] invalid UI state'); return; }

    const playerId = clampPlayerId();
    setMsg("");

    const pool = validGiftPool(playerId);
    if(pool.length === 0){
      console.log('[doOpen] no valid gifts');
      setResult(null, null);
      setMsg("‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏ï‡πà‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÉ‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà)", false);
      openBtn.disabled = true;
      return;
    }

    const pickedGift = pool[Math.floor(Math.random()*pool.length)];
    console.log('[doOpen] pickedGift=', pickedGift, 'for player=', playerId);

    setBusy(true);
    try{ 
      await openSequence(pickedGift, playerId);
      // Auto remove after 2 seconds
      await wait(2000);
    }
    finally{
      console.log('[doOpen] finally: clearing busy and removing');
      setBusy(false);
      doRemove();
      updatePlayerValidityUI();
    }
  }

  // ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô: ‡∏•‡∏ö ‚Äú‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‚Äù + ‡∏•‡πá‡∏≠‡∏Å ‚Äú‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‚Äù
  function doRemove(){
    if(busy) return;
    if(lastGift == null || lastPlayer == null) return;

    const giftNo = lastGift;
    const playerNo = lastPlayer;

    if(!availableGifts.includes(giftNo)){
      setMsg("‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
      return;
    }

    availableGifts = availableGifts.filter(v=>v!==giftNo);
    removedGifts.push({ player: playerNo, gift: giftNo });

    if (!usedPlayers.includes(playerNo)) usedPlayers.push(playerNo);

    setResult(null, null);
    renderPills();
    
    // Auto-populate next player's number with the gift number (from 2nd player onwards)
    if (usedPlayers.length > 0 && availableGifts.length > 0) {
      playerInput.value = String(giftNo);
    } else {
      playerInput.value = "";
    }
    
    setMsg(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${playerNo} ‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${giftNo}`, true);
    renderGiftSelector();
    updatePlayerValidityUI();
    renderHistoryDisplay();
  }


  function renderHistoryDisplay(){
    historyDisplay.innerHTML = "";
    if (removedGifts.length === 0) return;
    
    const lines = removedGifts.map((r, idx) => `‚úì ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${r.player} ‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${r.gift}`);
    historyDisplay.innerHTML = lines.join("<br>");
  }

  function renderGiftSelector(){
    giftSelector.innerHTML = "";
    const playerIdVal = Number(playerInput.value);
    const randomNotClicked = !randomPlayerBtn.disabled;
    const hasValidPlayer = Number.isFinite(playerIdVal) && joinedPlayers.length > 0 && !randomNotClicked;
    
    if (allGiftNumbers.length === 0) {
      giftSelector.innerHTML = '<div class="t" style="color:var(--mut)">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß üéä</div>';
      return;
    }
    
    allGiftNumbers.forEach(giftNo => {
      const btn = document.createElement("button");
      btn.className = "giftBox-btn";
      
      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏°‡∏µ‡πÉ‡∏ô boxToGift)
      const isUsed = boxToGift.hasOwnProperty(giftNo);
      
      if (isUsed) {
        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
        btn.innerHTML = `<span style="font-size:22px; font-weight:900">${boxToGift[giftNo]}</span>`;
      } else {
        btn.innerHTML = "üéÅ";
      }
      
      btn.disabled = isUsed || !hasValidPlayer;
      btn.title = isUsed ? `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß` : (!hasValidPlayer ? `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏™‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å` : `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ô‡∏µ‡πâ`);
      btn.addEventListener("click", () => {
        if (busy || isUsed || !hasValidPlayer) return;
        btn.disabled = true;
        selectGiftBox(giftNo);
      });
      giftSelector.appendChild(btn);
    });
  }

  function renderHistoryDisplay(){
    historyDisplay.innerHTML = "";
    if (removedGifts.length === 0) return;
    
    const lines = removedGifts.map((r, idx) => `‚úì ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${r.player} ‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡πÄ‡∏•‡∏Ç ${r.gift}`);
    historyDisplay.innerHTML = lines.join("<br>");
  }

  async function selectGiftBox(selectedGiftNo){
    console.log('[selectGiftBox] selectedGiftNo=', selectedGiftNo);
    if (busy) { console.log('[selectGiftBox] busy, abort'); return; }

    const playerId = clampPlayerId();
    if (!Number.isFinite(playerId)) { console.log('[selectGiftBox] invalid player'); return; }
    if (busy) { console.log('[selectGiftBox] busy again, abort'); return; }
    
    setMsg("");

    // ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏à‡∏≤‡∏Å pre-assigned derangement (‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
    const actualGift = giftAssignment[playerId];
    if (!actualGift || !availableGifts.includes(actualGift)) {
      setMsg("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ", false);
      console.error('[selectGiftBox] gift assignment error for player', playerId, '- assigned gift:', actualGift);
      return;
    }
    console.log('[selectGiftBox] using pre-assigned gift:', actualGift, 'for player:', playerId);

    setBusy(true);
    renderGiftSelector();
    await new Promise(r => requestAnimationFrame(r));
    
    try{
      updatePlayerValidityUI();
      console.log('[selectGiftBox] starting shake/open/overlay sequence');
      // 1) shake the box to the left for suspense (0.8s, faster & stronger)
      scene.classList.add('shakeLeft');
      await wait(850);
      scene.classList.remove('shakeLeft');
      await new Promise(r => requestAnimationFrame(r));

      // 2) open the lid locally (0.9s)
      scene.classList.add('opening');
      await wait(950);
      // keep lid open briefly while we show overlay

      // 3) show full-screen overlay spinner / reveal (boxFakeSpin holds for 3.5s)
      await boxFakeSpin(actualGift);

      // 4) after overlay closes, play lid closing animation (0.9s)
      scene.classList.remove('opening');
      scene.classList.add('closing');
      await wait(950);
      
      // 5) close small box and record result for removal
      scene.classList.remove('closing');
      resetBoxVisual();
      lastGift = actualGift;
      lastPlayer = playerId;
      
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏≠‡∏∞‡πÑ‡∏£
      boxToGift[selectedGiftNo] = actualGift;

      await wait(120);
    }
    finally{
      console.log('[selectGiftBox] sequence finished; cleaning up');
      setBusy(false);
      doRemove();
      updatePlayerValidityUI();
      renderGiftSelector();
    }
  }

  // small spin animation inside the box: cycle numbers then settle to target
  async function boxFakeSpin(target){
    try{
      console.log('[boxFakeSpin] start, target=', target);
      const choices = allGiftNumbers.length ? allGiftNumbers.slice() : availableGifts.slice();
      if (!choices.length) return;

      // use the same full-screen overlay as the fake draw
      let overlay = document.getElementById('randomOverlay');
      if (!overlay){
        overlay = document.createElement('div'); overlay.id = 'randomOverlay';
        document.body.appendChild(overlay);
      }
      overlay.innerHTML = `<canvas id="confettiOverlay"></canvas><div class="santa left"><img src="https://api.iconify.design/noto:santa-claus.svg" alt="Santa"></div><div class="santa right"><img src="https://api.iconify.design/noto:santa-claus.svg" alt="Santa"></div><div class="randomBox"><div class="num" id="randomNum">‚Äì</div><div class="sub">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á...</div></div>`;
      // init overlay confetti context when created
      confO = overlay.querySelector('#confettiOverlay');
      if (confO) cctxO = confO.getContext('2d');
      resizeConfettiOverlay();

      const numEl = overlay.querySelector('#randomNum');
      console.log('[boxFakeSpin] overlay shown, choices=', choices.length);
      overlay.classList.add('show');
      // size overlay canvas now that it's visible
      resizeConfettiOverlay();
      if (confO) cctxO = confO.getContext('2d');

      const spinDuration = 1500; // ms
      const step = 80; // ms per change
      const start = Date.now();
      while (Date.now() - start < spinDuration){
        const pick = choices[Math.floor(Math.random() * choices.length)];
        numEl.textContent = String(pick);
        await wait(step);
      }

      // final
      numEl.textContent = String(target);
      console.log('[boxFakeSpin] final target displayed ->', target);
      // trigger overlay-specific confetti (full-screen)
      fireConfettiOverlay();
      // keep full-screen reveal (3.5s) before closing
      await wait(3500);
      overlay.classList.remove('show');
      // hide/cleanup overlay confetti after overlay closes
      clearConfettiOverlay();
    }catch(e){ console.error('[boxFakeSpin] error', e); }
  }

  function renderPills(){
    // Update counts
    remainEl.textContent = availableGifts.length;
    joinCountEl.textContent = joinedPlayers.length;
    usedCountEl.textContent = usedPlayers.length;

    // Players: show joined set; strike out used
    playerPillsEl.innerHTML = "";
    const usedSet = new Set(usedPlayers);
    const joinedSet = new Set(joinedPlayers);
    
    joinedPlayers.forEach(i => {
      const p = document.createElement("span");
      const isUsed = usedSet.has(i);
      p.className = "numPill clickable" + (isUsed ? " gone" : "");
      p.dataset.num = i;
      p.textContent = i;
      p.title = isUsed ? "‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß" : "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏µ‡πâ";
      
      if (!isUsed) {
        p.addEventListener("click", () => {
          playerInput.value = String(i);
          setResult(null, null);
          resetBoxVisual();
          updatePlayerValidityUI();
        });
      }
      
      playerPillsEl.appendChild(p);
    });

    // Gifts: show SAME joined set; strike out removed
    giftPillsEl.innerHTML = "";
    const availGiftSet = new Set(availableGifts);
    joinedPlayers.forEach(i => {
      const s = document.createElement("span");
      const isAvail = availGiftSet.has(i);
      s.className = "numPill" + (isAvail ? "" : " gone");
      s.textContent = i;
      s.title = isAvail ? "‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà" : "‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ñ‡∏π‡∏Å‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß";
      giftPillsEl.appendChild(s);
    });

    const v = Number(playerInput.value);
    highlightActivePlayerPill(Number.isFinite(v) && joinedSet.has(v) && !usedSet.has(v) ? v : null);
  }

  // --- Setup modal ---
  function openSetupModal(force=false){
    if (busy) return;
    setupSelection = new Set(joinedPlayers.length ? joinedPlayers : []);
    buildSetupGrid();
    setupOverlay.classList.add("show");
    setupOverlay.setAttribute("aria-hidden","false");
    setupCloseBtn.style.visibility = force ? "hidden" : "visible";
    updateSetupStartState();
    document.body.style.overflow = 'hidden';
  }

  function closeSetupModal(){
    setupOverlay.classList.remove("show");
    setupOverlay.setAttribute("aria-hidden","true");
    setupCloseBtn.style.visibility = "visible";
    document.body.style.overflow = '';
  }

  function buildSetupGrid(){
    setupGrid.innerHTML = "";
    for(let i=1;i<=N;i++){
      const p = document.createElement("div");
      p.className = "pickPill" + (setupSelection.has(i) ? " on" : "");
      p.textContent = i;
      p.addEventListener("click", () => {
        if (setupSelection.has(i)) setupSelection.delete(i);
        else setupSelection.add(i);
        p.classList.toggle("on");
        updateSetupStartState();
      });
      setupGrid.appendChild(p);
    }
  }

  function updateSetupStartState(){
    const count = setupSelection.size;
    setupWarn.style.opacity = (count >= 2) ? "0.3" : "1";
    setupStartBtn.disabled = count < 2;
  }

  // Shuffle array (Fisher-Yates)
  function shuffle(arr) {
    const result = arr.slice();
    for (let i = result.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [result[i], result[j]] = [result[j], result[i]];
    }
    return result;
  }

  // Derangement: shuffle array so NO element is in its original position
  function createDerangement(arr) {
    const sorted = arr.slice().sort((a, b) => a - b);
    let attempt = 0;
    const maxAttempts = 100;

    while (attempt < maxAttempts) {
      const shuffled = shuffle(sorted.slice());
      // Check if this is a valid derangement
      let isValid = true;
      for (let i = 0; i < sorted.length; i++) {
        if (sorted[i] === shuffled[i]) {
          isValid = false;
          break;
        }
      }
      if (isValid) {
        console.log('[createDerangement] found valid derangement after', attempt + 1, 'attempts:', shuffled);
        return shuffled;
      }
      attempt++;
    }

    // Fallback (shouldn't happen with reasonable array size): rotate by 1
    console.warn('[createDerangement] fallback: rotating by 1');
    const fallback = sorted.slice();
    fallback.push(fallback.shift());
    return fallback;
  }

  function applySetupPlayers(){
    // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∏‡∏î‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô
    joinedPlayers = Array.from(setupSelection).sort((a,b)=>a-b);

    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á derangement: ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç = ‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
    allGiftNumbers = joinedPlayers.slice();
    const deranged = createDerangement(joinedPlayers);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á mapping: ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô i -> ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç deranged[i]
    giftAssignment = {};
    joinedPlayers.forEach((playerId, idx) => {
      giftAssignment[playerId] = deranged[idx];
    });
    console.log('[applySetupPlayers] derangement mapping:', giftAssignment);
    
    availableGifts = allGiftNumbers.slice();
    removedGifts = [];
    usedPlayers = [];
    boxToGift = {};

    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏•/‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å
    playerInput.value = "";
    setResult(null, null);
    resetBoxVisual();

    renderPills();
    renderGiftSelector();
    renderHistoryDisplay();
    updatePlayerValidityUI();
    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà
    try{ if (randomPlayerBtn) randomPlayerBtn.disabled = false; } catch(e){}
    setMsg(`‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô ${joinedPlayers.length} ‡∏Ñ‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç ${joinedPlayers.length} ‡∏ä‡∏¥‡πâ‡∏ô`, true);
  }

  // --- Reset modal ---
  function openResetModal(){
    if (busy) return;
    resetText.value = "";
    resetConfirmBtn.disabled = true;
    resetOverlay.classList.add("show");
    resetOverlay.setAttribute("aria-hidden","false");
    setTimeout(() => resetText.focus(), 0);
    document.body.style.overflow = 'hidden';
  }
  function closeResetModal(){
    resetOverlay.classList.remove("show");
    resetOverlay.setAttribute("aria-hidden","true");
    resetText.value = "";
    resetConfirmBtn.disabled = true;
    document.body.style.overflow = '';
  }
  function applyResetNow(){
    joinedPlayers = [];
    availableGifts = [];
    allGiftNumbers = [];
    removedGifts = [];
    usedPlayers = [];
    boxToGift = {};
    giftAssignment = {};
    playerInput.value = "";
    setResult(null, null);
    renderPills();
    renderGiftSelector();
    renderHistoryDisplay();
    resetBoxVisual();
    updatePlayerValidityUI();
    try{ if (randomPlayerBtn) randomPlayerBtn.disabled = false; } catch(e){}
    setMsg("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà)", true);
    openSetupModal(true);
  }

  // Events
  openBtn.addEventListener("click", doOpen);
  removeBtn.addEventListener("click", doRemove);
  randomPlayerBtn.addEventListener("click", () => {
    if (busy) return;
    // start full-screen fake draw then set player
    startFakeDraw();
  });

  setupBtn.addEventListener("click", () => openSetupModal(false));

  // Setup modal buttons
  setupCloseBtn.addEventListener("click", closeSetupModal);
  setupOverlay.addEventListener("click", (e) => {
    if (e.target === setupOverlay && setupCloseBtn.style.visibility !== "hidden") closeSetupModal();
  });
  setupSelectAll.addEventListener("click", () => {
    setupSelection = new Set(Array.from({length:N}, (_,i)=>i+1));
    buildSetupGrid();
    updateSetupStartState();
  });
  setupClearAll.addEventListener("click", () => {
    setupSelection = new Set();
    buildSetupGrid();
    updateSetupStartState();
  });
  setupStartBtn.addEventListener("click", () => {
    applySetupPlayers();
    closeSetupModal();
  });

  resetBtn.addEventListener("click", openResetModal);
  resetCloseBtn.addEventListener("click", closeResetModal);
  resetCancelBtn.addEventListener("click", closeResetModal);
  resetOverlay.addEventListener("click", (e) => {
    if (e.target === resetOverlay) closeResetModal();
  });
  resetText.addEventListener("input", () => {
    const ok = resetText.value.trim().toUpperCase() === "RESET";
    resetConfirmBtn.disabled = !ok;
  });
  resetText.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !resetConfirmBtn.disabled) {
      e.preventDefault();
      resetConfirmBtn.click();
    }
    if (e.key === "Escape") {
      e.preventDefault();
      closeResetModal();
    }
  });
  resetConfirmBtn.addEventListener("click", () => {
    closeResetModal();
    applyResetNow();
  });

  // typing player id -> validate
  playerInput.addEventListener("input", () => {
    if (busy) return;
    setResult(null, null);
    resetBoxVisual();
    updatePlayerValidityUI();
  });

  // Global ESC closes modals
  document.addEventListener("keydown", (e) => {
    if (e.key !== "Escape") return;
    if (resetOverlay.classList.contains("show")) { e.preventDefault(); closeResetModal(); }
    else if (setupOverlay.classList.contains("show") && setupCloseBtn.style.visibility !== "hidden") { e.preventDefault(); closeSetupModal(); }
  });

  // Init
  renderPills();
  setResult(null, null);
  updatePlayerValidityUI();

  // Display build timestamp
  const buildTime = document.getElementById('buildTime');
  if (buildTime) {
    const now = new Date();
    buildTime.textContent = now.toLocaleString('th-TH', { 
      year: 'numeric', month: 'short', day: 'numeric', 
      hour: '2-digit', minute: '2-digit' 
    });
  }

  // Force choose players before start
  openSetupModal(true);
})();
</script>
</body>
</html>
